# docker build -t varfor/apprtc:v1.0 -f .\APPRTC_SERVER .

# docker run --rm \
#   -e Candidate=124.223.98.45 \
#   -e ICE_IP=124.223.98.45 \
#   -e ICE_PORT=3478 \
#   -it varfor/apprtc:v1.0

FROM ubuntu:16.04

LABEL version="1.0" description="AppRTC Server" author="leo" 

ENV DEBIAN_FRONTEND=noninteractive

WORKDIR /webrtc/

ENV GAE_VER 1.9.74
ENV GOLANG_VER 1.8.3
ENV LIBEVENT_VER 2.1.12
ENV COTURN_VER 4.5.0.7

ENV Candidate 127.0.0.1

ENV ICE_IP 127.0.0.1
ENV ICE_PORT 3478

RUN apt update -y

# Deps
RUN apt install -y build-essential vim git curl wget unzip python2.7 python-webtest-doc python-pip libssl-dev openjdk-8-jdk

# RUN pip install --upgrade pip
RUN python -m pip install --user --upgrade pip==20.3.4 -i https://pypi.tuna.tsinghua.edu.cn/simple/
RUN pip install requests -i https://pypi.tuna.tsinghua.edu.cn/simple/
RUN pip install supervisor -i https://pypi.tuna.tsinghua.edu.cn/simple/
RUN pip install git+https://gitee.com/mirrors_bendikro/supervisord-dependent-startup.git

# NodeJS
RUN curl -sL https://deb.nodesource.com/setup_14.x | bash -
RUN apt install -y nodejs
RUN mkdir -p /webrtc/log/

# Golang
ENV GOLANG_TAR go$GOLANG_VER.linux-amd64.tar.gz
RUN wget https://storage.googleapis.com/golang/$GOLANG_TAR
RUN tar -C /usr/local -xzf $GOLANG_TAR
ENV PATH $PATH:/usr/local/go/bin
ENV GOPATH /webrtc/goWorkspace
RUN mkdir -p $GOPATH/src
RUN mkdir -p $GOPATH/src/golang.org/x
RUN git clone https://gitee.com/liweixiang1234/net.git $GOPATH/src/golang.org/x/net
RUN git clone https://gitee.com/spypxf/tools.git $GOPATH/src/golang.org/tools



# Google App Engine
ENV GAE_ZIP google_appengine_$GAE_VER.zip
RUN wget https://storage.googleapis.com/appengine-sdks/featured/$GAE_ZIP
RUN unzip $GAE_ZIP -d /usr/local
ENV PATH $PATH:/usr/local/google_appengine

# AppRTC
WORKDIR /webrtc/
RUN git clone https://gitee.com/mcmeet_dev/apprtc.git

WORKDIR /webrtc/apprtc/

RUN ln -s /webrtc/apprtc/src/collider/collider $GOPATH/src
RUN ln -s /webrtc/apprtc/src/collider/collidermain $GOPATH/src
RUN ln -s /webrtc/apprtc/src/collider/collidertest $GOPATH/src
# RUN export GOPROXY=https://proxy.golang.com.cn,direct
RUN go get collidermain
RUN go install collidermain

RUN npm install -g npm
RUN npm install -g grunt-cli

RUN npm install

RUN grunt build

EXPOSE 8080 8089 3478 3033 9001

WORKDIR /webrtc/apprtc/

RUN npm install express
COPY ice.js /webrtc/
COPY constants.py /webrtc/apprtc/out/app_engine/constants.py

# Clean up APT when done.
RUN apt clean && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

COPY apprtc_supervisord.conf /webrtc/

COPY run.sh /webrtc/

RUN chmod +x /webrtc/run.sh

CMD /webrtc/run.sh
